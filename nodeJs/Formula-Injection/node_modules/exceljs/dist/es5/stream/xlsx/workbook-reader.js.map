{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-reader.js"],"names":["fs","require","EventEmitter","PassThrough","Readable","nodeStream","unzip","tmp","iterateStream","parseSax","StyleManager","WorkbookXform","RelationshipsXform","WorksheetReader","HyperlinkReader","setGracefulCleanup","WorkbookReader","input","options","worksheets","sharedStrings","hyperlinks","styles","entries","init","createReadStream","Error","parse","eventType","value","emit","read","Symbol","asyncIterator","stream","_getStream","zip","Parse","forceStream","pipe","waitingWorkSheets","entry","match","sheetNo","path","_parseRels","_parseWorkbook","_parseSharedStrings","_parseStyles","workbookRels","_parseWorksheet","Promise","resolve","reject","file","err","fd","tempFileCleanupCallback","push","tempStream","createWriteStream","on","_parseHyperlinks","autodrain","fileStream","payload","xform","parseStream","_emitEntry","type","workbook","properties","map","workbookPr","model","text","richText","index","font","events","node","name","bold","charset","parseInt","attributes","color","rgb","argb","val","theme","family","italic","outline","size","underline","vertAlign","length","iterator","id","worksheetReader","matchingRel","find","rel","Target","matchingSheet","sheets","sheet","rId","Id","state","hyperlinksReader","Options","module","exports"],"mappings":"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","sourcesContent":["const fs = require('fs');\r\nconst {EventEmitter} = require('events');\r\nconst {PassThrough, Readable} = require('readable-stream');\r\nconst nodeStream = require('stream');\r\nconst unzip = require('unzipper');\r\nconst tmp = require('tmp');\r\nconst iterateStream = require('../../utils/iterate-stream');\r\nconst parseSax = require('../../utils/parse-sax');\r\n\r\nconst StyleManager = require('../../xlsx/xform/style/styles-xform');\r\nconst WorkbookXform = require('../../xlsx/xform/book/workbook-xform');\r\nconst RelationshipsXform = require('../../xlsx/xform/core/relationships-xform');\r\n\r\nconst WorksheetReader = require('./worksheet-reader');\r\nconst HyperlinkReader = require('./hyperlink-reader');\r\n\r\ntmp.setGracefulCleanup();\r\n\r\nclass WorkbookReader extends EventEmitter {\r\n  constructor(input, options = {}) {\r\n    super();\r\n\r\n    this.input = input;\r\n\r\n    this.options = {\r\n      worksheets: 'emit',\r\n      sharedStrings: 'cache',\r\n      hyperlinks: 'ignore',\r\n      styles: 'ignore',\r\n      entries: 'ignore',\r\n      ...options,\r\n    };\r\n\r\n    this.styles = new StyleManager();\r\n    this.styles.init();\r\n  }\r\n\r\n  _getStream(input) {\r\n    if (input instanceof nodeStream.Readable || input instanceof Readable) {\r\n      return input;\r\n    }\r\n    if (typeof input === 'string') {\r\n      return fs.createReadStream(input);\r\n    }\r\n    throw new Error(`Could not recognise input: ${input}`);\r\n  }\r\n\r\n  async read(input, options) {\r\n    try {\r\n      for await (const {eventType, value} of this.parse(input, options)) {\r\n        switch (eventType) {\r\n          case 'shared-strings':\r\n            this.emit(eventType, value);\r\n            break;\r\n          case 'worksheet':\r\n            this.emit(eventType, value);\r\n            await value.read();\r\n            break;\r\n          case 'hyperlinks':\r\n            this.emit(eventType, value);\r\n            break;\r\n        }\r\n      }\r\n      this.emit('end');\r\n      this.emit('finished');\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n    }\r\n  }\r\n\r\n  async *[Symbol.asyncIterator]() {\r\n    for await (const {eventType, value} of this.parse()) {\r\n      if (eventType === 'worksheet') {\r\n        yield value;\r\n      }\r\n    }\r\n  }\r\n\r\n  async *parse(input, options) {\r\n    if (options) this.options = options;\r\n    const stream = (this.stream = this._getStream(input || this.input));\r\n    const zip = unzip.Parse({forceStream: true});\r\n    stream.pipe(zip);\r\n\r\n    // worksheets, deferred for parsing after shared strings reading\r\n    const waitingWorkSheets = [];\r\n\r\n    for await (const entry of iterateStream(zip)) {\r\n      let match;\r\n      let sheetNo;\r\n      switch (entry.path) {\r\n        case '_rels/.rels':\r\n          break;\r\n        case 'xl/_rels/workbook.xml.rels':\r\n          await this._parseRels(entry);\r\n          break;\r\n        case 'xl/workbook.xml':\r\n          await this._parseWorkbook(entry);\r\n          break;\r\n        case 'xl/sharedStrings.xml':\r\n          yield* this._parseSharedStrings(entry);\r\n          break;\r\n        case 'xl/styles.xml':\r\n          await this._parseStyles(entry);\r\n          break;\r\n        default:\r\n          if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\r\n            sheetNo = match[1];\r\n            if (this.sharedStrings && this.workbookRels) {\r\n              yield* this._parseWorksheet(iterateStream(entry), sheetNo);\r\n            } else {\r\n              // create temp file for each worksheet\r\n              await new Promise((resolve, reject) => {\r\n                tmp.file((err, path, fd, tempFileCleanupCallback) => {\r\n                  if (err) {\r\n                    return reject(err);\r\n                  }\r\n                  waitingWorkSheets.push({sheetNo, path, tempFileCleanupCallback});\r\n\r\n                  const tempStream = fs.createWriteStream(path);\r\n                  entry.pipe(tempStream);\r\n                  return tempStream.on('finish', () => {\r\n                    return resolve();\r\n                  });\r\n                });\r\n              });\r\n            }\r\n          } else if (entry.path.match(/xl\\/worksheets\\/_rels\\/sheet\\d+[.]xml.rels/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\r\n            sheetNo = match[1];\r\n            yield* this._parseHyperlinks(iterateStream(entry), sheetNo);\r\n          }\r\n          break;\r\n      }\r\n      entry.autodrain();\r\n    }\r\n\r\n    for (const {sheetNo, path, tempFileCleanupCallback} of waitingWorkSheets) {\r\n      let fileStream = fs.createReadStream(path);\r\n      // TODO: Remove once node v8 is deprecated\r\n      // Detect and upgrade old fileStreams\r\n      if (!fileStream[Symbol.asyncIterator]) {\r\n        fileStream = fileStream.pipe(new PassThrough());\r\n      }\r\n      yield* this._parseWorksheet(fileStream, sheetNo);\r\n      tempFileCleanupCallback();\r\n    }\r\n  }\r\n\r\n  _emitEntry(payload) {\r\n    if (this.options.entries === 'emit') {\r\n      this.emit('entry', payload);\r\n    }\r\n  }\r\n\r\n  async _parseRels(entry) {\r\n    const xform = new RelationshipsXform();\r\n    this.workbookRels = await xform.parseStream(iterateStream(entry));\r\n  }\r\n\r\n  async _parseWorkbook(entry) {\r\n    this._emitEntry({type: 'workbook'});\r\n\r\n    const workbook = new WorkbookXform();\r\n    await workbook.parseStream(iterateStream(entry));\r\n\r\n    this.properties = workbook.map.workbookPr;\r\n    this.model = workbook.model;\r\n  }\r\n\r\n  async *_parseSharedStrings(entry) {\r\n    this._emitEntry({type: 'shared-strings'});\r\n    switch (this.options.sharedStrings) {\r\n      case 'cache':\r\n        this.sharedStrings = [];\r\n        break;\r\n      case 'emit':\r\n        break;\r\n      default:\r\n        return;\r\n    }\r\n\r\n    let text = null;\r\n    let richText = [];\r\n    let index = 0;\r\n    let font = null;\r\n    for await (const events of parseSax(iterateStream(entry))) {\r\n      for (const {eventType, value} of events) {\r\n        if (eventType === 'opentag') {\r\n          const node = value;\r\n          switch (node.name) {\r\n            case 'b':\r\n              font = font || {};\r\n              font.bold = true;\r\n              break;\r\n            case 'charset':\r\n              font = font || {};\r\n              font.charset = parseInt(node.attributes.charset, 10);\r\n              break;\r\n            case 'color':\r\n              font = font || {};\r\n              font.color = {};\r\n              if (node.attributes.rgb) {\r\n                font.color.argb = node.attributes.argb;\r\n              }\r\n              if (node.attributes.val) {\r\n                font.color.argb = node.attributes.val;\r\n              }\r\n              if (node.attributes.theme) {\r\n                font.color.theme = node.attributes.theme;\r\n              }\r\n              break;\r\n            case 'family':\r\n              font = font || {};\r\n              font.family = parseInt(node.attributes.val, 10);\r\n              break;\r\n            case 'i':\r\n              font = font || {};\r\n              font.italic = true;\r\n              break;\r\n            case 'outline':\r\n              font = font || {};\r\n              font.outline = true;\r\n              break;\r\n            case 'rFont':\r\n              font = font || {};\r\n              font.name = node.value;\r\n              break;\r\n            case 'si':\r\n              font = null;\r\n              richText = [];\r\n              text = null;\r\n              break;\r\n            case 'sz':\r\n              font = font || {};\r\n              font.size = parseInt(node.attributes.val, 10);\r\n              break;\r\n            case 'strike':\r\n              break;\r\n            case 't':\r\n              text = null;\r\n              break;\r\n            case 'u':\r\n              font = font || {};\r\n              font.underline = true;\r\n              break;\r\n            case 'vertAlign':\r\n              font = font || {};\r\n              font.vertAlign = node.attributes.val;\r\n              break;\r\n          }\r\n        } else if (eventType === 'text') {\r\n          text = text ? text + value : value;\r\n        } else if (eventType === 'closetag') {\r\n          const node = value;\r\n          switch (node.name) {\r\n            case 'r':\r\n              richText.push({\r\n                font,\r\n                text,\r\n              });\r\n\r\n              font = null;\r\n              text = null;\r\n              break;\r\n            case 'si':\r\n              if (this.options.sharedStrings === 'cache') {\r\n                this.sharedStrings.push(richText.length ? {richText} : text);\r\n              } else if (this.options.sharedStrings === 'emit') {\r\n                yield {index: index++, text: richText.length ? {richText} : text};\r\n              }\r\n\r\n              richText = [];\r\n              font = null;\r\n              text = null;\r\n              break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  async _parseStyles(entry) {\r\n    this._emitEntry({type: 'styles'});\r\n    if (this.options.styles === 'cache') {\r\n      this.styles = new StyleManager();\r\n      await this.styles.parseStream(iterateStream(entry));\r\n    }\r\n  }\r\n\r\n  *_parseWorksheet(iterator, sheetNo) {\r\n    this._emitEntry({type: 'worksheet', id: sheetNo});\r\n    const worksheetReader = new WorksheetReader({\r\n      workbook: this,\r\n      id: sheetNo,\r\n      iterator,\r\n      options: this.options,\r\n    });\r\n\r\n    const matchingRel = (this.workbookRels || []).find(\r\n      rel => rel.Target === `worksheets/sheet${sheetNo}.xml`\r\n    );\r\n    const matchingSheet =\r\n      matchingRel && (this.model.sheets || []).find(sheet => sheet.rId === matchingRel.Id);\r\n    if (matchingSheet) {\r\n      worksheetReader.id = matchingSheet.id;\r\n      worksheetReader.name = matchingSheet.name;\r\n      worksheetReader.state = matchingSheet.state;\r\n    }\r\n    if (this.options.worksheets === 'emit') {\r\n      yield {eventType: 'worksheet', value: worksheetReader};\r\n    }\r\n  }\r\n\r\n  *_parseHyperlinks(iterator, sheetNo) {\r\n    this._emitEntry({type: 'hyperlinks', id: sheetNo});\r\n    const hyperlinksReader = new HyperlinkReader({\r\n      workbook: this,\r\n      id: sheetNo,\r\n      iterator,\r\n      options: this.options,\r\n    });\r\n    if (this.options.hyperlinks === 'emit') {\r\n      yield {eventType: 'hyperlinks', value: hyperlinksReader};\r\n    }\r\n  }\r\n}\r\n\r\n// for reference - these are the valid values for options\r\nWorkbookReader.Options = {\r\n  worksheets: ['emit', 'ignore'],\r\n  sharedStrings: ['cache', 'emit', 'ignore'],\r\n  hyperlinks: ['cache', 'emit', 'ignore'],\r\n  styles: ['cache', 'ignore'],\r\n  entries: ['emit', 'ignore'],\r\n};\r\n\r\nmodule.exports = WorkbookReader;\r\n"],"file":"workbook-reader.js"}