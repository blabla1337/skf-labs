# KBID 67 - Open Redirect Harder-2

## Running the app

```
$ docker pull blabla1337/owasp-skf-lab:url-redirection-harder2
```

```
$ docker run -ti -p 127.0.0.1:5000:5000 blabla1337/owasp-skf-lab:url-redirection-harder2
```

{% hint style="success" %}
Now that the app is running let's go hacking!
{% endhint %}

## Running the app Python3

First, make sure python3 and pip are installed on your host machine. After installation, we go to the folder of the lab we want to practise "i.e /skf-labs/XSS/, /skf-labs/jwt-secret/ " and run the following commands:

```
$ pip3 install -r requirements.txt
```

```
$ python3 <labname>
```

{% hint style="success" %}
Now that the app is running let's go hacking!
{% endhint %}

![Docker Image and write-up thanks to ContraHack!](../../.gitbook/assets/screen-shot-2019-03-04-at-21.33.32.png)

## Reconnaissance

### Step 1

The application shows that there is a new version of the website available somewhere, and a click on the button "Go to new website" will redirect you to it.

If we click on the button we will be redirected on the new page [http://localhost:5000/newsite](http://localhost:5000/newsite)

### Step 2

Intercepting the traffic generated by the application, we note that the redirection is performed using the following call

```
GET /redirect?newurl=newsite
```

that will generate a 302 Redirect response from the server

Exactly like in the previous example (KBID XXX). If we look at the code we discover a tiny difference: a blacklist!

```python
landing_page = request.args.get('newurl')

    if blacklist(landing_page):
        return render_template("index.html", content = "Sorry, you cannot use \".\" and \"/\" in the redirect. Good luck!")
    return redirect(landing_page, 302)
```

If we look at the blacklist definition, we can immediately see that the URL, in order to be valid, must not contain any "." (dot) and "/\\" (forward slash).

```python
def blacklist(url):
    blacklist = [".","/"]
    for b in blacklist:
        if url.find(b) != -1:
            return True
    return False
```

### Step 3

Let's verify the effectiveness of this blacklist. If we try to exploit the unvalidated redirect using an external website, we see that the application blocks us, returning an error in the page.

If we URL encode the dot the application is smart enough to decode it and recognise it in the URL, blocking us again.

## Exploitation

Although we cannot explicitly use the dot character, we can find different ways to bypass the blacklist. In example we could use the following techniques:

- double encoding: `https://google%252ecom`&#x20;
- UTF-8 encoding: `https://google.com%E3%80%82com`
- Can you find more?&#x20;

The "." (dot) blacklist bypass is done, now it's time of "\\/" (forward slash).

Double encoding won't work on this case because the browser doesn't understand the URL redirection of duble encoded "/\\".

With HTTPS protocol, the "\\/" can be omitted. The browser will understand this URL and fix the "mistake" and will add the missing protocol double forward slashes.

Therefore, the final payload is:

```
http://localhost:5000/redirect?newurl=https:google%252ecom
```

- Can you find more ways to bypass "\\/" blacklist validation?&#x20;

Using the payload above we will be able to successfully redirect a user to a malicious website

## Additional sources

- [https://www.owasp.org/index.php/Testing_for_Client_Side_URL_Redirect\_(OTG-CLIENT-004)](<https://www.owasp.org/index.php/Testing_for_Client_Side_URL_Redirect_(OTG-CLIENT-004)>)
